const fs = require('fs');
const axios = require("axios");
const axiosRetry = require('axios-retry');

require('console-stamp')(console, {
  metadata: function () {
    return ('[' + process.memoryUsage().rss + ']');
  },
  colors: {
    stamp: 'yellow',
    label: 'white',
    metadata: 'green'
  }
});

axiosRetry(axios, {
  retries: 6
});
axiosRetry(axios, {
  retryDelay: (retryCount) => {
    return retryCount * 10000;
  }
});

const cnpjApiURL = `https://www.receitaws.com.br/v1/cnpj`;
const cnpjApiToken = `your_api_token_here`;

// Bazil health insurance CNPJs. 
// TODO: make this list dynamic
const cnpjOpsList = ['29309127000179', '63554067000198', '44649812000138', '92693118000160', '01685053000156', '16513178000176', '02812468000106', '04540010000170', '42163881000101', '87096616000196', '33719485000127', '01613433000185', '46124624000111', '43643139000166', '75055772000120', '31925548000176', '04487255000181', '61849980000196', '03658432000182', '00461479000163', '02866602000151', '18275071000162', '62550256000120', '02933220000101', '27578434000120', '05868278000107', '02476067000122', '43293604000186', '76882612000117', '01518211000183', '00360305000104', '04201372000137', '33592510000154', '33000167000101', '02403281000159', '31240963000196', '57746455000178', '03533726000188', '04311093000126', '19878404000100', '11214624000128', '87827689000100', '75222224000147', '25250820000162', '00773639000100', '45100138000109', '77858611000108', '73809352000166', '28630531000187', '58229691000180', '87300448000109', '76590884000143', '08380701000105', '78339439000130', '00558356000145', '08680639000177', '44803922000102', '76767219000182', '45232246000127', '67839969000121', '04299138000194', '02668512000156', '12442737000143', '17689407000170', '02902680000164', '60975174000100', '44673382000190', '04800040000179', '50739135000141', '02725347000127', '60214517000105', '17790718000121', '03315918000118', '82624776000147', '82602327000106', '56727134000163', '02864364000145', '44863959000126', '44456036000150', '45359213000142', '47184510000120', '07241136000132', '01892976000189', '88645403000139', '81170003000175', '45272366000158', '01387625000110', '49364193000159', '62638374000194', '76717040000110', '48628366000136', '96509690000188', '74466137000172', '17774738000109', '29135795000127', '44295962000190', '03011072000122', '49210966000142', '32440968000125', '31488208000125', '02464179000163', '13360276000122', '13001218000102', '62465117000106', '66872888000160', '28714533000154', '45399961000159', '01370425000155', '00628107000189', '16991945000152', '08202035000115', '02852017000100', '03123146000112', '03518900000113', '45309606000141', '01838723000127', '15214919000155', '00361325000108', '35830868000101', '77781706000162', '51502821000167', '59847780000152', '10395358000114', '83506030000100', '30036685000197', '00338763000147', '21490586000190', '18321477000134', '60961422000155', '40853020000120', '88258884000120', '42892281000184', '82996703000186', '11939445000158', '62231527000184', '04558034000157', '24449225000198', '87158507000156', '25658691000146', '85377174000120', '84537141000138', '04612990000170', '87547444000120', '39419809000198', '25471574000179', '12055813000168', '87647756000105', '73967085000155', '03629963000147', '34269803000168', '95642179000197', '35917970000130', '58837188000107', '64924095000112', '45646726000134', '12682451000135', '73717639000166', '68668045000172', '92741016000173', '21575709000195', '78931391000155', '71737001000161', '40294225000112', '04467112000108', '85283299000191', '02849393000138', '04272692000188', '39384664000137', '16921561000163', '37275625000176', '09237009000195', '24676884000167', '25335803000128', '50480953000172', '24014235000109', '03849449000117', '87497368000195', '84112481000117', '53678264000165', '49320799000192', '14112023000100', '07142821000101', '60633369000163', '65471914000186', '08707473000135', '78613841000161', '54012406000113', '92827666000136', '54370630000187', '80871551000160', '00697509000135', '45118429000116', '02862447000103', '45425899000122', '24368771000102', '04202013000102', '75054940000162', '15300953000142', '37135365000133', '02597394000132', '12838821000180', '02315431000172', '04083773000130', '68392604000164', '00453863000114', '25646761000146', '13342878000157', '65422339000121', '64486285000103', '20168589000149', '44663631000166', '29167970000168', '66343559000122', '05814777000103', '23802218000165', '17505793000101', '17845504000105', '07583396000196', '01559455000104', '73936395000102', '85241339000132', '37313475000148', '09433795000104', '38499547000156', '79115762000193', '74521188000150', '26189530000113', '62511019000150', '05657234000120', '28806545000109', '16415598000110', '04439627000102', '24645912000189', '26629238000174', '89870547000151', '41781949000153', '35988963000120', '56384183000140', '15395999000192', '04745753000187', '04004287000189', '42160192000143', '51427540000197', '78044815000160', '23854409000170', '00352294000110', '13245683000199', '60499365000134', '03424929000136', '45999141000106', '75003525000180', '04257073000114', '51093193000103', '44857357000166', '35908607000159', '72783970000111', '15594468000129', '00103956000119', '87607149000111', '02322043000119', '31934805000136', '33546979000157', '87306361000149', '84313741000112', '10219897000100', '81715716000177', '14946109000120', '07057185000110', '45572583000163', '31466949000105', '05011316000100', '33683111000107', '00885918000165', '79831608000118', '02282844000106', '77375897000162', '89890172000191', '10935483000170', '01445199000124', '23869306000184', '15131148000132', '00304148000110', '02877955000157', '25910449000118', '21839519000138', '54991211000162', '73395469000140', '08097092000181', '66854779000110', '97388490000187', '59849182000112', '81697419000146', '80238926000159', '78420783000150', '31787625000179', '42043067000153', '82956996000178', '66477217000103', '25329079000120', '81076069000109', '25810946000144', '87689527000153', '07844436000106', '82353079000107', '29290152000158', '42940528000190', '05029064000139', '00950062000164', '33530486000129', '42182170000184', '87701249000102', '00366982000130', '62635990000191', '71063853000110', '87638334000173', '03098226000165', '81064511000179', '30417661000188', '65732836000126', '64388812000139', '00668790000188', '02687852000124', '08883265000197', '03773153000160', '69259356000140', '01032102000151', '81564346000114', '68709211000131', '17143876000190', '02752923000125', '00111826000128', '66191263000133', '22720791000167', '00006037000127', '32538373000107', '02562406000193', '06091170000105', '67417519000140', '59981712000181', '02026403000135', '34274233000102', '81710543000102', '57149775000140', '35642768000143', '11828089000103', '69087922000184', '01193663000132', '03638220000133', '16665579000141', '85177194000158', '57553265000134', '85246916000189', '42889436000123', '08708980000193', '37436920000167', '01356020000162', '12321527000105', '65276354000109', '01554266000149', '07649106000160', '51473692000126', '84638345000165', '92128610000193', '41871989000196', '57214900000159', '02774736000142', '27067508000163', '37382009000114', '17469701000177', '22669931000110', '15323270000100', '03657699000155', '71925531000133', '26291484000169', '20320487000105', '37880952000157', '65140725000120', '04518814000173', '45171402000197', '83367342000171', '00946953000147', '50368034000101', '48721401000167', '03033006000153', '90790072000172', '81710865000143', '71695746000105', '39210844000100', '02140364000100', '20909271000171', '17273560000112', '42855999000109', '00660903000107', '78953023000108', '11076382000153', '45383106000150', '72957814000120', '50432863000106', '19240166000103', '26150979000178', '13373539000138', '69289171000189', '70523899000102', '13223975000120', '71499792000139', '68682715000105', '22666341000133', '04165719000133', '11867361000156', '55189930000127', '02906583000140', '01143922000110', '90403874000182', '47565155000139', '42278796000199', '52852100000140', '81733115000197', '63202063000140', '00494870000164', '25064148000110', '00730439000170', '00552181000169', '00539806000152', '36862415000111', '15787592000100', '33721226000130', '36540979000138', '00381694000154', '11593821000103', '02888465000156', '20946877000187', '90747908000156', '53454617000143', '04002216000147', '28974020000182', '88732318000108', '00397695000197', '64327059000171', '01569902000106', '88870092000101', '80653975000158', '23984844000110', '03613857000175', '15713057000105', '00034259000153', '25971433000115', '83937631000169', '02903477000102', '96182068000108', '60878576000188', '47902648000117', '04463083000106', '01476619000130', '25686544000180', '26461699000180', '56762172000157', '02716508000116', '28502128000172', '04859814000137', '00152753000112', '59499251000105', '07893499000152', '42939207000176', '49008568000148', '02341467000120', '12585261000108', '04204285000133', '02172353000102', '22263081000155', '00368318000120', '41905498000119', '23278898000160', '41687179000184', '90619818000180', '43999424000114', '42946061000196', '72234164000194', '26032244000140', '53807475000150', '02989632000155', '02418258000138', '42425561000182', '62476676000103', '63367700000139', '00147571000153', '00395988000135', '23053901000147', '71064539000152', '20119509000165', '02881039000190', '21205801000163', '45207131000182', '00840048000108', '02896924000143', '26368613000170', '02248344000140', '72173180000114', '00307714000147', '80525652000189', '72127210000156', '05676572000109', '66916305000156', '59901454000186', '15022430000181', '86584901000193', '20961779000119', '28023703000154', '66343534000129', '13086566000120', '22027346000116', '34063123000193', '00747041000146', '37898335000189', '02912196000116', '16926969000128', '45467404000128', '68204486000113', '04574626000162', '05054671000159', '48717516000188', '07781345000179', '67577171000159', '34268789000188', '71186886000158', '80297161000128', '11565995000154', '71559272000174', '89100135000132', '07699082000153', '53535654000186', '37652765000116', '01029782000154', '41191677000131', '01659087000176', '66835794000111', '00299149000113', '03980208000102', '02402002000132', '92219070000153', '42936518000181', '27836329000143', '27626696000112', '14799035000147', '66453168000160', '17897995000138', '52657079000121', '57272510000135', '22103771000147', '03473372000123', '00365720000150', '00636975000100', '14408631000159', '72918287000144', '16608812000154', '01648339000161', '02009924000184', '61740791000180', '85137891000185', '03977587000181', '03637776000105', '30460075000116', '31754070000169', '58512310000175', '36751634000123', '00262338000111', '41369935000127', '00532888000103', '89640452000141', '27533116000142', '11177786000133', '00012698000165', '00303696000125', '01148132000128', '37035441000139', '03702977000149', '27816487000131', '07945024000162', '89761670000134', '03548273000163', '60498417000158', '15215452000168', '92316124000107', '72500697000170', '01012474000116', '13170410000122', '52505153000194', '03029587000150', '11996146000155', '59762062000183', '00200720000109', '00469585000193', '02513939000185', '28483261000129', '42509257000113', '43776491000170', '03670297000190', '09306242000182', '01371135000126', '72350382000194', '01591800000197', '00216547000129', '00580481000151', '06258813000162', '30123640000150', '41511429000120', '14576780000127', '28151363000147', '86483542000188', '20918393000124', '02858169000102', '06814351000112', '03897847000109', '50949528000180', '00322818000120', '02618303000106', '13100755000100', '03268622000193', '90450412000116', '49797293000179', '12317012000123', '71565659000133', '92240605000178', '00253137000158', '02018620000183', '02041808000142', '02192677000102', '72863665000130', '71086698000158', '00073957000168', '18987107000130', '13816250000146', '03044492000105', '04299994000140', '24294787000100', '01052203000194', '42465310000121', '12049486000131', '25063964000100', '00444803000135', '00342481000113', '25205234000104', '68737857000122', '24729097000136', '10225225000108', '03627391000167', '08315806000180', '72547623000190', '23557177000199', '22928119000161', '19529478000131', '19557487000136', '27085968000114', '35617257000171', '04197511000104', '01599587000160', '29640612000120', '41657081000184', '02030246000131', '29780384000194', '00648506000101', '19691730000104', '42515882000178', '78304672000188', '71753297000104', '19969500000164', '00665690000106', '40960189000189', '72916364000127', '69612158000119', '01232527000104', '25141173000150', '02849078000100', '19512026000147', '01130185000111', '00642842000147', '60851615000153', '11336728000105', '51262335000119', '66491036000123', '44945962000199', '10540020000109', '02220135000198', '59766105000107', '16822554000104', '20600763000180', '27316538000166', '93507895000136', '00763923000103', '11334600000102', '00490723000116', '33601568000117', '59007799000190', '05914650000166', '03298573000131', '04839091000104', '01474814000120', '66493339000185', '02341470000144', '73565319000138', '70094578000130', '00211378000134', '04503249000170', '32076630000136', '02569472000195', '02314168000105', '03219363000100', '03230123000107', '34011288000111', '13083167000105', '68687722000108', '92911056000116', '22694698000125', '00864888000100', '13026081000140', '30505523000150', '20160828000114', '06145428000109', '03391009000169', '17146846000137', '69599934000198', '02127779000136', '01647867000104', '07027515000124', '81140873000100', '08056815000102', '37501103000145', '01608379000180', '05455431000166', '04234059000103', '27113113000150', '02838972000185', '42150664000187', '77893469000121', '51628360000173', '04388452000143', '10169852000160', '31160674000187', '63089205000105', '31432792000105', '01409581000182', '48090146000100', '19891852000144', '02511261000100', '18571164000134', '32894974000152', '00755186000199', '93209765000117', '05351257000101', '41972589000177', '89633135000106', '18780232000175', '20437133000137', '01773319000112', '22296115000108', '01432102000149'];


axios.defaults.headers.common = {
  'Authorization': `bearer ${cnpjApiToken}`
}

const listReady = (dir, files = []) =>
  fs.readdirSync(dir).map(f => files.concat(f.replace(".json", ""))[0]);

const listReadyFiles = (dir, filelist = []) => fs.readdirSync(dir)
  .map(file => fs.statSync(path.join(dir, file)).isDirectory() ?
    walkSync(path.join(dir, file), filelist) :
    filelist.concat(path.join(dir, file))[0])

const readFile = (path, opts = 'utf8') =>
  new Promise((resolve, reject) => {
    fs.readFile(path, opts, (err, data) => {
      if (err) reject(err)
      else resolve(data)
    })
  });

function listPending(a1, a2) {

  var a = [],
    diff = [];

  for (var i = 0; i < a1.length; i++) {
    a[a1[i]] = true;
  }

  for (var i = 0; i < a2.length; i++) {
    if (a[a2[i]]) {
      delete a[a2[i]];
    } else {
      a[a2[i]] = true;
    }
  }

  for (var k in a) {
    diff.push(k);
  }

  return diff;
};


function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

const writeFile = (path, data, opts = 'utf8') =>
  new Promise((resolve, reject) => {
    fs.writeFile(path, data, opts, (err) => {
      if (err) reject(err)
      else resolve()
    })
  });

const getData = async cnpj => {
  try {
    const response = await axios.get(`${cnpjApiURL}/${cnpj}`);
    const data = response.data;
    console.log(`${data.nome} CNPJ ${data.cnpj} done!`);
    return data;
  } catch (error) {
    console.dir(error);
    return null;
  }
};

async function work() {
  let ready = listReady(`./OpsCNPJInfo/`);
  let pending = listPending(cnpjOpsList, ready);
  console.log("All: ", cnpjOpsList.length);
  console.log("Ready", ready.length);
  console.log("Pending: ", pending.length);

  for (let i = 0; i < pending.length; i++) {
    let cnpj = pending[i];
    data = await getData(cnpj);
    if (data) {
      await writeFile(`./OpsCNPJInfo/${cnpj}.json`, JSON.stringify(data));
      await sleep(22000);
    } else {
      return;
    }
  }
};

work();
